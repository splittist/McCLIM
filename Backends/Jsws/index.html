<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jsws</title>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.4.0/fabric.min.js"></script>
    <script>
        const canvas = new fabric.Canvas('canvas')

        canvas.setDimensions({width: window.innerWidth, height: window.innerHeight})

        function drawLine(args) {
            let line = new fabric.Line(args[0],args[1])
            canvas.add(line)
        }

        function drawRect(args) {
            let rect = new fabric.Rect(args)
            canvas.add(rect)
        }

        function drawCircle(args) {
            let circle = new fabric.Circle(args)
            canvas.add(circle)
        }

        function drawEllipse(args) {
            let ellipse = new fabric.Ellipse(args)
            canvas.add(ellipse)
        }

        function drawPolygon(args) {
            let polygon = new fabric.Polygon(args[0], args[1])
            canvas.add(polygon)
        }

        function drawPolyline(args) {
            let polyline = new fabric.Polyline(args[0], args[1])
            canvas.add(polyline)
        }

        function drawText(args) {
            let text = new fabric.Text(args[0], args[1])
            canvas.add(text)
        }

        function textSize(args) {
            const string = args[0]
            const options = args[1]
            const ctx = canvas.getContext('2d')
            ctx.font = `${options.fontStyle} ${options.fontWeight} ${options.fontSize}px ${options.fontFamily}`
            let metrics = ctx.measureText(string)
            let width = Math.abs(metrics.actualBoundingBoxLeft) + Math.abs(metrics.actualBoundingBoxRight)
            let height = Math.abs(metrics.actualBoundingBoxAscent) + Math.abs(metrics.actualBoundingBoxDescent)
            ws.send(`(:text-size ${args[2]} ${width} ${height})`)
        }

        const ws = new WebSocket('ws://127.0.0.1:4242/port')

        ws.onmessage = (event) => {
            const fns = {
                drawLine: drawLine,
                drawRect: drawRect,
                drawCircle: drawCircle,
                drawEllipse: drawEllipse,
                drawPolygon: drawPolygon,
                drawPolyline: drawPolyline,
                drawText: drawText,
                textSize: textSize,
            }
            let messages = JSON.parse(event.data)
            messages.forEach(([fName, ...args]) => fns[fName](...args))
        }

        ws.onopen = () => {
            console.log('Connected')
        }

        ws.onclose = () => {
            console.log('Disconnected')
        }
    </script>
</body>
</html>